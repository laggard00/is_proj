<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Najam bicikla</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-white text-dark">
<div class="container my-4">
  <h1 class="mb-3">Najam bicikla</h1>
  <div class="mb-3">
    <button id="refresh-bikes" class="btn btn-primary btn-sm">Refresh bicikla</button>
    <button id="refresh-res" class="btn btn-secondary btn-sm">Refresh rezervacija</button>
    <button id="refresh-reserved" class="btn btn-success btn-sm">Refresh rezervirani bicikli</button>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h3>Bicikl</h3>
      <table class="table table-sm">
        <thead><tr><th>ID</th><th>Ime</th><th>Serijski-broj</th><th>Slika</th><th>Opcije</th></tr></thead>
        <tbody id="bikes"></tbody>
      </table>

      <h5>Dodaj/ Obir≈°i</h5>
      <form id="bike-form">
        <input type="hidden" id="bike-id">
        <div class="mb-2"><input class="form-control form-control-sm" id="serial" placeholder="Serijski broj"></div>
        <div class="mb-2"><input class="form-control form-control-sm" id="name" placeholder="ime"></div>
        <div class="mb-2">
          <input class="form-control form-control-sm" id="image" type="file" accept="image/*">
        </div>
        <button class="btn btn-outline-primary btn-sm" type="submit">Spremi</button>
        <button id="clear" type="button" class="btn btn-outline-danger btn-sm">Odustani</button>
      </form>
    </div>

    <div class="col-md-6">
      <h3>Rezervacij</h3>
      <table class="table table-sm">
        <thead><tr><th>Id</th><th>Bicikl</th><th>Od</th><th>Do</th><th>Tel.Broj</th><th>Opcije</th></tr></thead>
        <tbody id="reservations"></tbody>
      </table>

      <h5>Dodaj rezervaciju</h5>
      <form id="res-form">
        <div class="mb-2">
          <select id="bike-select" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
          <input id="start" type="datetime-local" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
          <input id="end" type="datetime-local" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
          <input id="phone" class="form-control form-control-sm" placeholder="Phone">
        </div>
        <button class="btn btn-outline-success btn-sm" type="submit">Dodaj</button>
      </form>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <h3>Rezervirani bicikli</h3>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ime bicikla</th>
            <th>Serijski broj</th>
            <th>Rezerviran od</th>
            <th>Rezerviran do</th>
            <th>Tel. broj</th>
          </tr>
        </thead>
        <tbody id="reserved"></tbody>
      </table>
      <div id="no-reserved" class="text-muted" style="display: none;">
        Nema rezerviranih bicikala.
      </div>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:5000';
let bikes = [];
let reserved = [];

const $ = id => document.getElementById(id);

async function loadBikes() {
  try {
    const res = await fetch(`${API}/api/bikes`);
    bikes = await res.json();
    showBikes();
    updateSelect();
  } catch (e) {
    console.error('Error loading', e);
  }
}

function showBikes() {
  const tbody = $('bikes');
  tbody.innerHTML = '';

  bikes.forEach(bike => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${bike.id}</td>
      <td>${bike.naziv}</td>
      <td>${bike.serijskibroj}</td>
      <td>${bike.slika ? `<img src="${bike.slika}" alt="Bike" style="max-height:40px;">` : ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary" onclick="editBike(${bike.id})">Edit</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteBike(${bike.id})">Delete</button>
      </td>
    `;
  });
}

async function loadReserved() {
  try {
    const res = await fetch(`${API}/api/reserved-bikes`);
    reserved = await res.json();
    showReserved();
    updateSelect();
  } catch (e) {
    console.error('Error', e);
  }
}

function showReserved() {
  const tbody = $('reserved');
  const noRes = $('no-reserved');
  tbody.innerHTML = '';

  if (reserved.length === 0) {
    noRes.style.display = 'block';
    return;
  }

  noRes.style.display = 'none';

  reserved.forEach(bike => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${bike.id}</td>
      <td>${bike.bike_name}</td>
      <td>${bike.serial_number}</td>
      <td>${bike.date_from || 'N/A'}</td>
      <td>${bike.date_to|| 'N/A'}</td>
      <td>${bike.phone || 'N/A'}</td>
    `;
  });
}

function updateSelect() {
  const select = $('bike-select');
  select.innerHTML = '<option value="">Select a bike</option>';

  const reservedIds = reserved.map(bike => bike.id);

  bikes.forEach(bike => {
    if (!reservedIds.includes(bike.id)) {
      const option = document.createElement('option');
      option.value = bike.id;
      option.text = `${bike.naziv} (${bike.serijskibroj})`;
      select.appendChild(option);
    }
  });
}

function editBike(id) {
  const bike = bikes.find(b => b.id === id);
  if (bike) {
    $('bike-id').value = bike.id;
    $('serial').value = bike.serijskibroj;
    $('name').value = bike.naziv;
  }
}

async function saveBike(e) {
  e.preventDefault();

  let img = '';
  const file = $('image');
  if (file.files && file.files[0]) {
    img = await toBase64(file.files[0]);
  }

  const data = {
    serijskibroj: $('serial').value,
    naziv: $('name').value,
    slika: img
  };

  const id = $('bike-id').value;

  try {
    if (id) {
      await fetch(`${API}/api/bikes/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
    } else {
      await fetch(`${API}/api/bikes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
    }

    clearForm();
    loadBikes();
  } catch (e) {
    console.error('Error saving bike:', e);
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
  });
}

async function deleteBike(id) {
  try {
    await fetch(`${API}/api/bikes/${id}`, {method: 'DELETE'});
    loadBikes();
  } catch (e) {
    console.error('Error brisanja:', e);
  }
}

function clearForm() {
  $('bike-form').reset();
  $('bike-id').value = '';
}

async function loadRes() {
  try {
    const res = await fetch(`${API}/api/reservations`);
    const reservations = await res.json();
    showRes(reservations);
  } catch (e) {
    console.error('Error', e);
  }
}

function showRes(reservations) {
  const tbody = $('reservations');
  tbody.innerHTML = '';

  reservations.forEach(res => {
    const row = tbody.insertRow();
    const finished = res.rezervacijazavrsena === 1;
    row.innerHTML = `
      <td>${res.id}</td>
      <td>${res.bicikl}</td>
      <td>${res.datumod}</td>
      <td>${res.datumdo}</td>
      <td>${res.telefonskibroj}</td>
      <td>
        <button
          class="btn btn-sm ${finished ? 'btn-danger' : 'btn-outline-success'}"
          onclick="finishRes(${res.id})"
          ${finished ? 'disabled' : ''}
        >
          Finish
        </button>
      </td>
    `;
  });
}

async function saveRes(e) {
  e.preventDefault();

  const data = {
    bike_id: $('bike-select').value,
    datumod: $('start').value,
    datumdo: $('end').value,
    telefonskibroj: $('phone').value
  };

  try {
    await fetch(`${API}/api/reservations`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    $('res-form').reset();
    loadRes();
    loadReserved();
  } catch (e) {
    console.error('Error', e);
  }
}

async function finishRes(id) {
  try {
    await fetch(`${API}/api/reservations/${id}/finish`, {method: 'PUT'});
    loadRes();
    loadReserved();
  } catch (e) {
    console.error('Error', e);
  }
}


$('bike-form').addEventListener('submit', saveBike);
$('clear').addEventListener('click', clearForm);
$('res-form').addEventListener('submit', saveRes);
$('refresh-bikes').addEventListener('click', loadBikes);
$('refresh-res').addEventListener('click', loadRes);
$('refresh-reserved').addEventListener('click', loadReserved);


loadBikes();
loadRes();
loadReserved();
</script>
</body>
</html>